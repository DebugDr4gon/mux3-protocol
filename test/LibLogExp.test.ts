import { ethers } from "hardhat"
import { expect } from "chai"
import { toWei, createContract } from "../scripts/deployUtils"
import { TestLibLogExp } from "../typechain"
const U = ethers.utils
const B = ethers.BigNumber

describe("LibLogExp", () => {
  let testLibLogExp: TestLibLogExp

  before(async () => {
    testLibLogExp = (await createContract("TestLibLogExp")) as TestLibLogExp
  })

  type ExpCase = {
    x: string
    y: string
  }

  // in mux3, the result of exp is around 0 ~ 3
  const libCases: ExpCase[] = [
    { x: "0", y: "1" },
    { x: "-6.589380000000000000", y: "0.001374892132543725" },
    { x: "-6.510823704410710370", y: "0.001487254160566202" },
    { x: "-6.432267408821420741", y: "0.001608798891029463" },
    { x: "-6.353711113232131111", y: "0.001740276773401180" },
    { x: "-6.275154817642841482", y: "0.001882499587068746" },
    { x: "-6.196598522053551852", y: "0.002036345453480954" },
    { x: "-6.118042226464262223", y: "0.002202764257903195" },
    { x: "-6.039485930874972593", y: "0.002382783514261517" },
    { x: "-5.960929635285682964", y: "0.002577514709286691" },
    { x: "-5.882373339696393334", y: "0.002788160165128666" },
    { x: "-5.803817044107103704", y: "0.003016020462813059" },
    { x: "-5.725260748517814075", y: "0.003262502472374041" },
    { x: "-5.646704452928524445", y: "0.003529128039243837" },
    { x: "-5.568148157339234816", y: "0.003817543380530849" },
    { x: "-5.489591861749945186", y: "0.004129529249201596" },
    { x: "-5.411035566160655557", y: "0.004467011928922779" },
    { x: "-5.332479270571365927", y: "0.004832075127448572" },
    { x: "-5.253922974982076297", y: "0.005226972841986057" },
    { x: "-5.175366679392786668", y: "0.005654143275973020" },
    { x: "-5.096810383803497038", y: "0.006116223893193933" },
    { x: "-5.018254088214207409", y: "0.006616067702182305" },
    { x: "-4.939697792624917779", y: "0.007156760871453584" },
    { x: "-4.861141497035628150", y: "0.007741641784329747" },
    { x: "-4.782585201446338520", y: "0.008374321651005160" },
    { x: "-4.704028905857048891", y: "0.009058706805118008" },
    { x: "-4.625472610267759261", y: "0.009799022822492341" },
    { x: "-4.546916314678469631", y: "0.010599840610966204" },
    { x: "-4.468360019089180002", y: "0.011466104632391389" },
    { x: "-4.389803723499890372", y: "0.012403163431054949" },
    { x: "-4.311247427910600743", y: "0.013416802657013090" },
    { x: "-4.232691132321311113", y: "0.014513280788232165" },
    { x: "-4.154134836732021484", y: "0.015699367772094922" },
    { x: "-4.075578541142731854", y: "0.016982386824854836" },
    { x: "-3.997022245553442225", y: "0.018370259647119452" },
    { x: "-3.918465949964152595", y: "0.019871555334535260" },
    { x: "-3.839909654374862965", y: "0.021495543285661490" },
    { x: "-3.761353358785573336", y: "0.023252250433700276" },
    { x: "-3.682797063196283706", y: "0.025152523155447047" },
    { x: "-3.604240767606994077", y: "0.027208094239703339" },
    { x: "-3.525684472017704447", y: "0.029431655328632986" },
    { x: "-3.447128176428414818", y: "0.031836935279333831" },
    { x: "-3.368571880839125188", y: "0.034438784929449941" },
    { x: "-3.290015585249835559", y: "0.037253268790190086" },
    { x: "-3.211459289660545929", y: "0.040297764232889187" },
    { x: "-3.132902994071256299", y: "0.043591068781517146" },
    { x: "-3.054346698481966670", y: "0.047153516173587588" },
    { x: "-2.975790402892677040", y: "0.051007101906057027" },
    { x: "-2.897234107303387411", y: "0.055175619041368675" },
    { x: "-2.818677811714097781", y: "0.059684805112143309" },
    { x: "-2.740121516124808152", y: "0.064562501031545524" },
    { x: "-2.661565220535518522", y: "0.069838822990480720" },
    { x: "-2.583008924946228892", y: "0.075546348402961511" },
    { x: "-2.504452629356939263", y: "0.081720317047719482" },
    { x: "-2.425896333767649633", y: "0.088398848647964504" },
    { x: "-2.347340038178360004", y: "0.095623178232686609" },
    { x: "-2.268783742589070374", y: "0.103437910732683491" },
    { x: "-2.190227446999780745", y: "0.111891296383257496" },
    { x: "-2.111671151410491115", y: "0.121035528633991571" },
    { x: "-2.033114855821201486", y: "0.130927066404977671" },
    { x: "-1.954558560231911856", y: "0.141626982679194158" },
    { x: "-1.876002264642622226", y: "0.153201341583333400" },
    { x: "-1.797445969053332597", y: "0.165721606285277295" },
    { x: "-1.718889673464042967", y: "0.179265080226687801" },
    { x: "-1.640333377874753338", y: "0.193915384414999864" },
    { x: "-1.561777082285463708", y: "0.209762973721744739" },
    { x: "-1.483220786696174079", y: "0.226905695374965938" },
    { x: "-1.404664491106884449", y: "0.245449393094009205" },
    { x: "-1.326108195517594820", y: "0.265508560596774690" },
    { x: "-1.247551899928305190", y: "0.287207048514359353" },
    { x: "-1.168995604339015560", y: "0.310678829077768115" },
    { x: "-1.090439308749725931", y: "0.336068823298072028" },
    { x: "-1.011883013160436301", y: "0.363533795747245536" },
    { x: "-0.933326717571146672", y: "0.393243322464295386" },
    { x: "-0.854770421981857042", y: "0.425380837962792080" },
    { x: "-0.776214126392567413", y: "0.460144767804306354" },
    { x: "-0.697657830803277783", y: "0.497749753730559963" },
    { x: "-0.619101535213988154", y: "0.538427978918582517" },
    { x: "-0.540545239624698524", y: "0.582430601541351400" },
    { x: "-0.461988944035408894", y: "0.630029305485099611" },
    { x: "-0.383432648446119265", y: "0.681517977797832630" },
    { x: "-0.304876352856829635", y: "0.737214523226065732" },
    { x: "-0.226320057267540006", y: "0.797462827043216138" },
    { x: "-0.147763761678250376", y: "0.862634878288671914" },
    { x: "-0.069207466088960747", y: "0.933133066526981025" },
    { x: "0.009348829500328883", y: "1.009392666307962427" },
    { x: "0.087905125089618513", y: "1.091884524667455336" },
    { x: "0.166461420678908142", y: "1.181117968262050733" },
    { x: "0.245017716268197772", y: "1.277643948087228809" },
    { x: "0.323574011857487401", y: "1.382058441195225251" },
    { x: "0.402130307446777031", y: "1.495006130415739376" },
    { x: "0.480686603036066660", y: "1.617184384799056351" },
    { x: "0.559242898625356290", y: "1.749347565357895373" },
    { x: "0.637799194214645919", y: "1.892311682692783714" },
    { x: "0.716355489803935549", y: "2.046959435258365545" },
    { x: "0.794911785393225179", y: "2.214245659378248909" },
    { x: "0.873468080982514808", y: "2.395203224658225327" },
    { x: "0.952024376571804438", y: "2.590949411197710273" },
    { x: "1.030580672161094067", y: "2.802692807974009437" },
    { x: "1.109136967750383697", y: "3.031740774991854792" },
    { x: "1.187693263339673326", y: "3.279507515271522955" },
    { x: "-23.025850929940457235", y: "0.000000000100000000" },
    { x: "-11.512925464970228617", y: "0.000010000000000000" },
    { x: "1.386294361119890572", y: "4.000000000000000000" },
    { x: "1.609437912434100282", y: "4.999999999999999112" },
  ]
  it("exp", async () => {
    for (const i of libCases) {
      expect(await testLibLogExp.exp(toWei(i.x))).to.be.closeTo(toWei(i.y), B.from("1000"))
    }
  })
  it("ln", async () => {
    for (const i of libCases) {
      expect(await testLibLogExp.ln(toWei(i.y))).to.be.closeTo(toWei(i.x), B.from("1000"))
    }
  })
  it("cost", async () => {
    let cost = 0
    for (const i of libCases) {
      let c = await testLibLogExp.estimateGas.exp(toWei(i.x))
      cost += c.toNumber()
      c = await testLibLogExp.estimateGas.ln(toWei(i.y))
      cost += c.toNumber()
    }
    console.log("logExp cost", cost)
    // version 1: 5921770
  })
})
